```{r, echo = FALSE, message = FALSE, warning=FALSE}
source(here::here("scripts/setup.R"))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Setting the functions to local environment "English" 
Sys.setlocale("LC_TIME", "C")
```

#### **Sion bike sharing**

Our work is to forecast the number of bikes available for every 10 minutes of Wednesday, May 25th, at every stations in the city of Sion.

To do so, we first compile for each stations the number of bikes available only on Wednesdays. It will help us to gain some insights on particular trends for this day of the week.

Most of the stations show a pattern between the hours from 06:00 to 12:00, where the amount of bikes decrease and then increase from 12:00 to 18:00. There are special cases in which those patterns are at the inverse, those signs could be related by the location of this stations, and the purpose of their users. 

* **Stations that Increase - Decrease** 
    + Campus Energypolis 
    + HÃ´pital - CRR 
    + Gare de Sion Sud 
    + Gare de Sion Nord (E-Bike)
    
* **Stations that Decrease - Increase** 
    + Bietschhorn 
    + Platta (E-Bike)
    + P+R Potence
    + Ancien Stand (E-Bike)
    

#### **Bietschhorn Station**

```{r, message=FALSE, warning=FALSE}
### Time series for Wednesdays - Bikes ###
bietschhorn_wednesdays_bikes %>% 
  autoplot(Number) +
  geom_vline(xintercept=c(54,198,342,486,630,774,918,1062,1206), linetype="dotted") + #Per day
  ggtitle("Wednesdays time series - Bike - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number")

```

```{r message=FALSE, warning=FALSE}
# Is it white noise for the bike at the bietschhorn? 
bietschhorn_wednesdays_bikes %>% 
  ACF(Number, lag_max = 144) %>% 
  autoplot() +  ggtitle("Bike")

# Is our time series stationary or not? #We confirm it with the test
bietschhorn_wednesdays_bike %>% features(Number, unitroot_kpss) 

#The p-value of 0.01 indicates strong evidence to 
#reject the null hypothesis of stationarity.

```

#### **Forecast**

> **Bike**

```{r, message=FALSE, warning=FALSE}
############################################################################################
                                      ###   Forecast  ###
############################################################################################

# Forecast for Bike in Bietschhorn
fit <- bietschhorn_wednesdays_bikes[1:1062,] %>%
  model(ETS = ETS(Number),
        ARIMA = ARIMA(Number),
        TSLM = TSLM(Number ~ trend())) %>%
  mutate(Combination = (ETS + ARIMA + TSLM) / 3)
fc <- fit %>% forecast(h = 144)
fc %>% autoplot(bietschhorn_wednesdays_bikes, level = NULL) +
  guides(colour=guide_legend(title = "Models")) +
  ggtitle("Wednesday Forecast - Bike - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number") 

# Compare models and arrange by RMSE to select the best
fc %>% accuracy(bietschhorn_wednesdays_bikes) %>% arrange(RMSE)


###################################   Linear Regression   ###############################

# Prepare data for Forecast
tslm <- bietschhorn_ts %>%
  dplyr::left_join(weather_data, by = "date") %>%
  na.omit() %>%
  filter(weekday == "Wednesday") %>%
  mutate(t = row_number()) %>% 
  update_tsibble(index = t, regular = TRUE)

######## Build the model for Bike #######

tslm_model_bike <- tslm[1:1008,] %>% 
  model(TSLM = TSLM(Bikes ~ Air_Temperature + Precipitation +
                      Virtual_Temperature + Wind_Speed))

# Look at the Coefficients and Residuals
report(tslm_model_bike)
tslm_model_bike %>% gg_tsresiduals()
```

#### Forecasting ####

```{r}
## BIKE ##

# Parameters for the forecast
day_forecasted = '2022-05-04'
station = bietschhorn_wednesdays_bikes

gsd_wednesdays_bike_fc <- station %>% 
  filter(as_date(date) < as_date(day_forecasted))

# Model with ETS and ARIMA
fit <- gsd_wednesdays_bike_fc %>%
  model(NAIVE = NAIVE(Number),
        ETS = ETS(Number),
        ARIMA = ARIMA(Number)) %>%
  mutate(Combination = (ETS + ARIMA + NAIVE) / 3)

fc <- fit %>% forecast(h = 144)

fc %>% autoplot(gsd_wednesdays_bike_fc, level = NULL) +
  guides(colour=guide_legend(title = "Models")) +
  ggtitle("Wednesday Forecast - Bikes - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number") 

station %>% 
  filter(as_date(date) <= as_date(day_forecasted)) %>% 
  autoplot(Number)

# Compare models and arrange by RMSE to select the best
fc %>% accuracy(gsd_wednesdays_bike_fc) %>% arrange(RMSE)
```

```{r}
### Linear regression TSLM ###

# Parameters
station_ts = bietschhorn_ts

# Keep only weather information for this time
weather_scenario <- weather_data %>% 
  filter(as_date(date) == as_date(day_forecasted))

# TSLM time series to get the weather data
tslm <- station_ts %>%
  dplyr::left_join(weather_data, by = "date") %>%
  na.omit() %>%
  filter(weekday == "Wednesday") %>%
  mutate(t = row_number()) %>% 
  update_tsibble(index = t, regular = TRUE)

# TSLM_forecast
tslm_forecast <- tslm %>% 
  filter(as_date(date) < as_date(day_forecasted))

# Create a scenario based on the inputs of weather
scenario <- new_data(tslm_forecast, n = 144) %>% 
  mutate(Air_Temperature=weather_scenario$Air_Temperature,
         Precipitation=weather_scenario$Precipitation,
         Virtual_Temperature=weather_scenario$Virtual_Temperature,
         Wind_Speed=weather_scenario$Wind_Speed)

# TSLM model
tslm_model_bike <- tslm_forecast %>% 
  model(TSLM = TSLM(Bikes ~ Air_Temperature + Precipitation +
                      Virtual_Temperature + Wind_Speed))

fc <- forecast(tslm_model_bike, new_data = scenario) %>% 
  as_fable(response = "Bikes")

tslm_forecast %>% 
  autoplot(Bikes) +
  autolayer(fc, level = 0)

tslm %>% 
  filter(as_date(date) <= as_date(day_forecasted)) %>% 
  autoplot(Bikes)
```