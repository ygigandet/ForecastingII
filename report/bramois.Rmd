#### **UNIL/UNIGE Bramois Station**aaaa

```{r, message=FALSE, warning=FALSE}
### Time series for Wednesdays - Bikes ###

# Parameters
interval = 1206

# Plot the time series for every wednesdays
bramois_wednesdays_bikes %>% 
  autoplot(Number) +
  geom_vline(xintercept=seq(54, interval, 144), linetype="dotted") + #Per day
  ggtitle("Wednesdays time series - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number of bikes available")
```


```{r message=FALSE, warning=FALSE}
# Is it white noise for the bike at the bietschhorn? 
bramois_wednesdays_bikes %>% 
  ACF(Number, lag_max = 144) %>% 
  autoplot() +  ggtitle("Bike")

# Is our time series stationary or not? #We confirm it with the test
bramois_wednesdays_bikes %>% features(Number, unitroot_kpss) 

#The p-value of 0.01 indicates strong evidence to 
#reject the null hypothesis of stationarity.

bramois_wednesdays_bikes %>% 
  model(STL = STL(Number)) %>% 
  components() %>% 
  autoplot()
```

```{r, message=FALSE, warning=FALSE}
############################################################################################
                                      ###  Forecasts  ###
############################################################################################

# Parameters for the forecast
day_forecasted = '2022-05-04'
station = bramois_wednesdays_bikes
station_ts = bramois_ts

# Forecast for bikes in Bramois
fit <- station[1:interval,] %>%
  model(ETS = ETS(Number),
        ARIMA = ARIMA(Number),
        NAIVE = NAIVE(Number)) %>%
  mutate(Combination = (ETS + ARIMA + NAIVE) / 3)

fc <- fit %>% forecast(h = 144)

fc %>% autoplot(station, level = NULL) +
  guides(colour=guide_legend(title = "Models")) +
  ggtitle("Forecast bikes - Bramois") +
  labs(x = "Time [10']",
       y = "Number") 

# Compare models and arrange by RMSE to select the best
fc %>% accuracy(station) %>% arrange(RMSE)


###################################   Linear Regression   ###############################

# Prepare data for Forecast
tslm <- station_ts %>%
  dplyr::left_join(weather_data, by = "date") %>%
  na.omit() %>%
  filter(weekday == "Wednesday") %>%
  mutate(t = row_number()) %>% 
  update_tsibble(index = t, regular = TRUE)

# Keep only weather information for this time
weather_scenario <- weather_data %>% 
  filter(as_date(date) == as_date(day_forecasted))

######## Build the model for Bike #######

bietschhorn_wednesdays_bikes_fc <- station %>% 
  filter(as_date(date) < as_date(day_forecasted))

# TSLM_forecast
tslm_forecast <- tslm %>% 
  filter(as_date(date) < as_date(day_forecasted))

# Create a scenario based on the inputs of weather
scenario <- new_data(tslm_forecast, n = 144) %>% 
  mutate(Air_Temperature=weather_scenario$Air_Temperature,
         Precipitation=weather_scenario$Precipitation,
         Virtual_Temperature=weather_scenario$Virtual_Temperature,
         Wind_Speed=weather_scenario$Wind_Speed)

# TSLM model
tslm_model_bikes <- tslm_forecast %>% 
  model(TSLM = TSLM(Bikes ~ trend() + Air_Temperature + Precipitation +
                      Virtual_Temperature + Wind_Speed))

fc <- forecast(tslm_model_bikes, new_data = scenario) %>% 
  as_fable(response = "Bikes")

tslm_forecast %>% 
  autoplot(Bikes) +
  autolayer(fc, level = 0)

tslm %>% 
  filter(as_date(date) <= as_date(day_forecasted)) %>% 
  autoplot(Bikes)

# Look at the Coefficients and Residuals
report(tslm_model_bikes)
tslm_model_bike %>% gg_tsresiduals()
```