## EDA

```{r, echo = FALSE, message = FALSE, warning=FALSE}
source(here::here("scripts/setup.R"))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Setting the functions to local environment "English" 
Sys.setlocale("LC_TIME", "C")
```

#### **Bietschhorn Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Bietschhorn <- as_tsibble(Bietschhorn)

weekday <- weekdays(Bietschhorn$date)
Bietschhorn$weekday <- weekday # Get the weekday values
Bietschhorn$time <- as.POSIXct(Bietschhorn$date, format = "%H:%M:%S %p")
Bietschhorn$time <- as.numeric(Bietschhorn$date) #convert date values to numeric
as.numeric(Bietschhorn$time)

bietschhorn <- Bietschhorn %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
bietschhorn$minutes <- as.numeric(as.character(bietschhorn$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
bietschhorn <- bietschhorn %>% filter(minutes == 10) %>%
  select(-time) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
bietschhorn.gaps <- has_gaps(bietschhorn)
bietschhorn.gaps <- scan_gaps(bietschhorn)
bietschhorn <- bietschhorn %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
bietschhorn_ts <- bietschhorn %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes, name)
scan_gaps(bietschhorn_ts) # no missing values

#  convert our data frame from wide to long format.
bietschhorn <- bietschhorn_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
bietschhorn %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Bietschhorn station")

# Sum Bikes with E-Bikes to have total column of bikes

bietschhorn_ts$Bietschhorn <- bietschhorn_ts$Bike + bietschhorn_ts$`E-Bike`
bietschhorn_ts <- bietschhorn_ts %>% 
  select(date, Bietschhorn)

# Apply STL Decomposition to see the patterns on the data
dcmp <- bietschhorn %>% filter(Types == "Bike" | Types == "Capacity") %>%
  model(STL(Number))
components(dcmp) %>% autoplot() + xlab("Date [10 min]")

dcmp <- bietschhorn %>% filter(Types == "E-Bike" | Types == "Capacity") %>%
  model(STL(Number))
components(dcmp) %>% autoplot() + xlab("Date [10 min]")

# Convert to stationary
bietschhorn <- bietschhorn %>% mutate(diff_number = difference(Number))
bietschhorn %>% filter(Types != "Capacity") %>% autoplot(diff_number)

# ACF plots to determine autocorrelation on the tables vs differenced 
p1 <- bietschhorn %>% filter(Types != "Capacity") %>% 
  ACF(Number, lag_max = 144) %>% autoplot()  # There are 144 intervals of 10 min in a day
p2 <- bietschhorn %>% filter(Types != "Capacity") %>% 
  ACF(diff_number, lag_max = 144) %>% autoplot()
p1 / p2

# Apply ETS Model
fit <- bietschhorn %>% filter(Types != "Capacity") %>% model(ETS(Number)) 
fit %>% forecast(h = 144) %>% autoplot(bietschhorn) +
  ggtitle("ETS Model") + xlab("Date [10 min]") + ylab("Number of bikes") 

# Apply ARIMA Model
fit <- bietschhorn %>% filter(Types != "Capacity") %>% model(ARIMA(Number)) 
fit %>% forecast(h = 144) %>% autoplot(bietschhorn) +
  ggtitle("ARIMA Model") + xlab("Date [10 min]") + ylab("Number of bikes") 


```

> Models applied

* Model: ARIMA(1,1,0)(0,0,2)[6] (Bike)
* Model: ARIMA(4,1,1)(1,0,0)[6] (E-Bike)
* Model: ETS(A,Ad,N) (Bike & E-Bike)

```{r, echo=FALSE, message=FALSE}
library(lubridate)
bietschhorn_monday <- bietschhorn %>%
  filter(weekday == "Monday") 
lubridate::day(bietschhorn_monday$date) <- 14
lubridate::month(bietschhorn_monday$date) <- 04
bietschhorn_monday <- bietschhorn_monday %>%
  group_by(date, Types) %>%
  summarise(Number = median(Number)) %>%
  as_tsibble(key = Types) %>%
  mutate(weekday = "Monday")
bietschhorn_monday$Number <- ceiling(bietschhorn_monday$Number)

bietschhorn_monday %>% 
  select(-weekday) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Bike usage on Monday")

bietschhorn_tuesday <- bietschhorn %>%
  filter(weekday == "Tuesday") 
lubridate::day(bietschhorn_tuesday$date) <- 15
lubridate::month(bietschhorn_tuesday$date) <- 04
bietschhorn_tuesday <- bietschhorn_tuesday %>%
  group_by(date, Types) %>%
  summarise(Number = median(Number)) %>%
  as_tsibble(key = Types) %>%
  mutate(weekday = "Tuesday")
bietschhorn_tuesday$Number <- ceiling(bietschhorn_tuesday$Number)

bietschhorn_tuesday %>% 
  select(-weekday) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Bike usage on Tuesday")

bietschhorn_wednesday <- bietschhorn %>%
  filter(weekday == "Wednesday") 
lubridate::day(bietschhorn_wednesday$date) <- 16
lubridate::month(bietschhorn_wednesday$date) <- 04
bietschhorn_wednesday <- bietschhorn_wednesday %>%
  group_by(date, Types) %>%
  summarise(Number = median(Number)) %>%
  as_tsibble(key = Types) %>%
  mutate(weekday = "Wednesday")
bietschhorn_wednesday$Number <- ceiling(bietschhorn_wednesday$Number)

bietschhorn_wednesday %>% 
  select(-weekday) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Bike usage on Wednesday")

bietschhorn_thursday <- bietschhorn %>%
  filter(weekday == "Thursday") 
lubridate::day(bietschhorn_thursday$date) <- 17
lubridate::month(bietschhorn_thursday$date) <- 04
bietschhorn_thursday <- bietschhorn_thursday %>%
  group_by(date, Types) %>%
  summarise(Number = median(Number)) %>%
  as_tsibble(key = Types) %>%
  mutate(weekday = "Thursday")
bietschhorn_thursday$Number <- ceiling(bietschhorn_thursday$Number)

bietschhorn_thursday %>% 
  select(-weekday) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Bike usage on Thursday")

bietschhorn_friday <- bietschhorn %>%
  filter(weekday == "Friday") 
lubridate::day(bietschhorn_friday$date) <- 18
lubridate::month(bietschhorn_friday$date) <- 04
bietschhorn_friday <- bietschhorn_friday %>%
  group_by(date, Types) %>%
  summarise(Number = median(Number)) %>%
  as_tsibble(key = Types) %>%
  mutate(weekday = "Friday")
bietschhorn_friday$Number <- ceiling(bietschhorn_friday$Number)

bietschhorn_friday %>% 
  select(-weekday) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Bike usage on Friday")

bietschhorn_saturday <- bietschhorn %>%
  filter(weekday == "Saturday") 
lubridate::day(bietschhorn_saturday$date) <- 19
lubridate::month(bietschhorn_saturday$date) <- 04
bietschhorn_saturday <- bietschhorn_saturday %>%
  group_by(date, Types) %>%
  summarise(Number = median(Number)) %>%
  as_tsibble(key = Types) %>%
  mutate(weekday = "Saturday")
bietschhorn_saturday$Number <- ceiling(bietschhorn_saturday$Number)

bietschhorn_saturday %>% 
  select(-weekday) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Bike usage on Saturday")

bietschhorn_sunday <- bietschhorn %>%
  filter(weekday == "Sunday") 
lubridate::day(bietschhorn_sunday$date) <- 20
lubridate::month(bietschhorn_sunday$date) <- 04
bietschhorn_sunday <- bietschhorn_sunday %>%
  group_by(date, Types) %>%
  summarise(Number = median(Number)) %>%
  as_tsibble(key = Types) %>%
  mutate(weekday = "Sunday")
bietschhorn_sunday$Number <- ceiling(bietschhorn_sunday$Number)

bietschhorn_sunday %>% 
  select(-weekday) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Bike usage on Sunday")
```

#### **Blancherie Station **

We note from the data sets that the time differences in a day are generally divided by 10 and 60 minutes, which is why we have considered dividing it by blocks of time difference per day, so we could interpret the usage patterns more easily. 

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Blancherie <- as_tsibble(Blancherie)
weekday <- weekdays(Blancherie$date)
Blancherie$weekday <- weekday # Get the weekday values
Blancherie$time <- as.POSIXct(Blancherie$date, format = "%H:%M:%S %p")
Blancherie$time <- as.numeric(Blancherie$date) #convert date values to numeric
as.numeric(Blancherie$time)

blancherie <- Blancherie %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
blancherie$minutes <- as.numeric(as.character(blancherie$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
blancherie <- blancherie %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
blancherie.gaps <- has_gaps(blancherie)
blancherie.gaps <- scan_gaps(blancherie)
blancherie <- blancherie %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
blancherie_ts <- blancherie %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(blancherie_ts) # no missing values

#  convert our data frame from wide to long format.
blancherie <- blancherie_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```

```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
blancherie %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Blancherie station")

# Sum Bikes with E-Bikes to have total column of bikes
blancherie_ts$Blancherie <- blancherie_ts$Bike + blancherie_ts$`E-Bike`
blancherie_ts <- blancherie_ts %>% 
  select(date, Blancherie)
```

#### **Cible Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Cible <- as_tsibble(Cible)
weekday <- weekdays(Cible$date)
Cible$weekday <- weekday # Get the weekday values
Cible$time <- as.POSIXct(Cible$date, format = "%H:%M:%S %p")
Cible$time <- as.numeric(Cible$date) #convert date values to numeric
as.numeric(Cible$time)

cible <- Cible %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
cible$minutes <- as.numeric(as.character(cible$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
cible <- cible %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
cible.gaps <- has_gaps(cible)
cible.gaps <- scan_gaps(cible)
cible <- cible %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
cible_ts <- cible %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(cible_ts) # no missing values

#  convert our data frame from wide to long format.
cible <- cible_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```



```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
cible %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Cible station")

# Sum Bikes with E-Bikes to have total column of bikes
cible_ts$Cible <- cible_ts$Bike + cible_ts$`E-Bike`
cible_ts <- cible_ts %>% 
  select(date, Cible)
```

#### **Gare de Sion Sud (GSD) Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
GSD <- as_tsibble(GSD)
weekday <- weekdays(GSD$date)
GSD$weekday <- weekday # Get the weekday values
GSD$time <- as.POSIXct(GSD$date, format = "%H:%M:%S %p")
GSD$time <- as.numeric(GSD$date) #convert date values to numeric
as.numeric(GSD$time)

gsd <- GSD %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
gsd$minutes <- as.numeric(as.character(gsd$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
gsd <- gsd %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
gsd.gaps <- has_gaps(gsd)
gsd.gaps <- scan_gaps(gsd)
gsd <- gsd %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
gsd_ts <- gsd %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(gsd_ts) # no missing values

#  convert our data frame from wide to long format.
gsd <- gsd_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
gsd %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Gare de Sion Sud station")

# Sum Bikes with E-Bikes to have total column of bikes
gsd_ts$GSD <- gsd_ts$Bike + gsd_ts$`E-Bike`
gsd_ts <- gsd_ts %>% 
  select(date, GSD)
```

#### **P+R Potence Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
PRP <- as_tsibble(PRP)
weekday <- weekdays(PRP$date)
PRP$weekday <- weekday # Get the weekday values
PRP$time <- as.POSIXct(PRP$date, format = "%H:%M:%S %p")
PRP$time <- as.numeric(PRP$date) #convert date values to numeric
as.numeric(PRP$time)

prp <- PRP %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
prp$minutes <- as.numeric(as.character(prp$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
prp <- prp %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
prp.gaps <- has_gaps(prp)
prp.gaps <- scan_gaps(prp)
prp <- prp %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
prp_ts <- prp %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(prp_ts) # no missing values

#  convert our data frame from wide to long format.
prp <- prp_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
prp %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in P+R Potences station")

# Sum Bikes with E-Bikes to have total column of bikes
prp_ts$PRP <- prp_ts$Bike + prp_ts$`E-Bike`
prp_ts <- prp_ts %>% 
  select(date, PRP)
```

#### **Platta Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Platta <- as_tsibble(Platta)
weekday <- weekdays(Platta$date)
Platta$weekday <- weekday # Get the weekday values
Platta$time <- as.POSIXct(Platta$date, format = "%H:%M:%S %p")
Platta$time <- as.numeric(Platta$date) #convert date values to numeric
as.numeric(Platta$time)

platta <- Platta %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
platta$minutes <- as.numeric(as.character(platta$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
platta <- platta %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
platta.gaps <- has_gaps(platta)
platta.gaps <- scan_gaps(platta)
platta <- platta %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
platta_ts <- platta %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(platta_ts) # no missing values

#  convert our data frame from wide to long format.
platta <- platta_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
platta %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Platta station")

# Sum Bikes with E-Bikes to have total column of bikes
platta_ts$Platta <- platta_ts$Bike + platta_ts$`E-Bike`
platta_ts <- platta_ts %>% 
  select(date, Platta)
```

#### **Planta Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Planta <- as_tsibble(Planta)
weekday <- weekdays(Planta$date)
Planta$weekday <- weekday # Get the weekday values
Planta$time <- as.POSIXct(Planta$date, format = "%H:%M:%S %p")
Planta$time <- as.numeric(Planta$date) #convert date values to numeric
as.numeric(Planta$time)

planta <- Planta %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
planta$minutes <- as.numeric(as.character(planta$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
planta <- planta %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
planta.gaps <- has_gaps(planta)
planta.gaps <- scan_gaps(planta)
planta <- planta %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
planta_ts <- planta %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(planta_ts) # no missing values

#  convert our data frame from wide to long format.
planta <- planta_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
planta %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Planta station")

# Sum Bikes with E-Bikes to have total column of bikes
planta_ts$Planta <- planta_ts$Bike + planta_ts$`E-Bike`
planta_ts <- planta_ts %>% 
  select(date, Planta)
```


#### **Hôpital - CRR Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
CRR <- as_tsibble(CRR)
weekday <- weekdays(CRR$date)
CRR$weekday <- weekday # Get the weekday values
CRR$time <- as.POSIXct(CRR$date, format = "%H:%M:%S %p")
CRR$time <- as.numeric(CRR$date) #convert date values to numeric
as.numeric(CRR$time)

crr <- CRR %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
crr$minutes <- as.numeric(as.character(crr$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
crr <- crr %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
crr.gaps <- has_gaps(crr)
crr.gaps <- scan_gaps(crr)
crr <- crr %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
crr_ts <- crr %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(crr_ts) # no missing values

#  convert our data frame from wide to long format.
crr <- crr_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
crr %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Hôpital - CRR station")

# Sum Bikes with E-Bikes to have total column of bikes
crr_ts$CRR <- crr_ts$Bike + crr_ts$`E-Bike`
crr_ts <- crr_ts %>% 
  select(date, CRR)
```


#### **Campus Energypolis Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Campus <- as_tsibble(Campus)
weekday <- weekdays(Campus$date)
Campus$weekday <- weekday # Get the weekday values
Campus$time <- as.POSIXct(Campus$date, format = "%H:%M:%S %p")
Campus$time <- as.numeric(Campus$date) #convert date values to numeric
as.numeric(Campus$time)

campus <- Campus %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
campus$minutes <- as.numeric(as.character(campus$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
campus <- campus %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
campus.gaps <- has_gaps(campus)
campus.gaps <- scan_gaps(campus)
campus <- campus %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
campus_ts <- campus %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(campus_ts) # no missing values

#  convert our data frame from wide to long format.
campus <- campus_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
campus %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Campus Energypolis station")

# Sum Bikes with E-Bikes to have total column of bikes
campus_ts$Campus <- campus_ts$Bike + campus_ts$`E-Bike`
campus_ts <- campus_ts %>% 
  select(date, Campus)
```

#### **Scex Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Scex <- as_tsibble(Scex)
weekday <- weekdays(Scex$date)
Scex$weekday <- weekday # Get the weekday values
Scex$time <- as.POSIXct(Scex$date, format = "%H:%M:%S %p")
Scex$time <- as.numeric(Scex$date) #convert date values to numeric
as.numeric(Scex$time)

scex <- Scex %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
scex$minutes <- as.numeric(as.character(scex$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
scex <- scex %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
scex.gaps <- has_gaps(scex)
scex.gaps <- scan_gaps(scex)
scex <- scex %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
scex_ts <- scex %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(scex_ts) # no missing values

#  convert our data frame from wide to long format.
scex <- scex_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
scex %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Scex station")

# Sum Bikes with E-Bikes to have total column of bikes
scex_ts$Scex <- scex_ts$Bike + scex_ts$`E-Bike`
scex_ts <- scex_ts %>% 
  select(date, Scex)
```

#### **Châteauneuf-Furet Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Furet <- as_tsibble(Furet)
weekday <- weekdays(Furet$date)
Furet$weekday <- weekday # Get the weekday values
Furet$time <- as.POSIXct(Furet$date, format = "%H:%M:%S %p")
Furet$time <- as.numeric(Furet$date) #convert date values to numeric
as.numeric(Furet$time)

furet <- Furet %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
furet$minutes <- as.numeric(as.character(furet$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
furet <- furet %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
furet.gaps <- has_gaps(furet)
furet.gaps <- scan_gaps(furet)
furet <- furet %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
furet_ts <- furet %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(furet_ts) # no missing values

#  convert our data frame from wide to long format.
furet <- furet_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```


```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
furet %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Châteauneuf-Furet station")

# Sum Bikes with E-Bikes to have total column of bikes
furet_ts$Furet <- furet_ts$Bike + furet_ts$`E-Bike`
furet_ts <- furet_ts %>% 
  select(date, Furet)
```

#### **Agasse Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Agasse <- as_tsibble(Agasse)
weekday <- weekdays(Agasse$date)
Agasse$weekday <- weekday # Get the weekday values
Agasse$time <- as.POSIXct(Agasse$date, format = "%H:%M:%S %p")
Agasse$time <- as.numeric(Agasse$date) #convert date values to numeric
as.numeric(Agasse$time)

agasse <- Agasse %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
agasse$minutes <- as.numeric(as.character(agasse$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
agasse <- agasse %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
agasse.gaps <- has_gaps(agasse)
agasse.gaps <- scan_gaps(agasse)
agasse <- agasse %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
agasse_ts <- agasse %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(agasse_ts) # no missing values

#  convert our data frame from wide to long format.
agasse <- agasse_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```

```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
agasse %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Agasse station")

# Sum Bikes with E-Bikes to have total column of bikes
agasse_ts$Agasse <- agasse_ts$Bike + agasse_ts$`E-Bike`
agasse_ts <- agasse_ts %>% 
  select(date, Agasse)
```


#### **P+R Stade Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Stade <- as_tsibble(Stade)
weekday <- weekdays(Stade$date)
Stade$weekday <- weekday # Get the weekday values
Stade$time <- as.POSIXct(Stade$date, format = "%H:%M:%S %p")
Stade$time <- as.numeric(Stade$date) #convert date values to numeric
as.numeric(Stade$time)

stade <- Stade %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
stade$minutes <- as.numeric(as.character(stade$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
stade <- stade %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
stade.gaps <- has_gaps(stade)
stade.gaps <- scan_gaps(stade)
stade <- stade %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
stade_ts <- stade %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(stade_ts) # no missing values

#  convert our data frame from wide to long format.
stade <- stade_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```

```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
stade %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in P+R Stade station")

# Sum Bikes with E-Bikes to have total column of bikes
stade_ts$Stade <- stade_ts$Bike + stade_ts$`E-Bike`
stade_ts <- stade_ts %>% 
  select(date, Stade)
```

#### **Gare de Sion Nord (GSN) Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
GSN <- as_tsibble(GSN)
weekday <- weekdays(GSN$date)
GSN$weekday <- weekday # Get the weekday values
GSN$time <- as.POSIXct(GSN$date, format = "%H:%M:%S %p")
GSN$time <- as.numeric(GSN$date) #convert date values to numeric
as.numeric(GSN$time)

gsn <- GSN %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
gsn$minutes <- as.numeric(as.character(gsn$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
gsn <- gsn %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
gsn.gaps <- has_gaps(gsn)
gsn.gaps <- scan_gaps(gsn)
gsn <- gsn %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
gsn_ts <- gsn %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(gsn_ts) # no missing values

#  convert our data frame from wide to long format.
gsn <- gsn_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```

```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
gsn %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Gare de Sion Nord (GSN) station")

# Sum Bikes with E-Bikes to have total column of bikes
gsn_ts$GSN <- gsn_ts$Bike + gsn_ts$`E-Bike`
gsn_ts <- gsn_ts %>% 
  select(date, GSN)
```

#### **Ancien Stand Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Stand <- as_tsibble(Stand)
weekday <- weekdays(Stand$date)
Stand$weekday <- weekday # Get the weekday values
Stand$time <- as.POSIXct(Stand$date, format = "%H:%M:%S %p")
Stand$time <- as.numeric(Stand$date) #convert date values to numeric
as.numeric(Stand$time)

stand <- Stand %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
stand$minutes <- as.numeric(as.character(stand$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
stand <- stand %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
stand.gaps <- has_gaps(stand)
stand.gaps <- scan_gaps(stand)
stand <- stand %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
stand_ts <- stand %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(stand_ts) # no missing values

#  convert our data frame from wide to long format.
stand <- stand_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```

```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
stand %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in Ancien Stand station")

# Sum Bikes with E-Bikes to have total column of bikes
stand_ts$Stand <- stand_ts$Bike + stand_ts$`E-Bike`
stand_ts <- stand_ts %>% 
  select(date, Stand)
```

#### **UNIL/UNIGE Bramois Station**

```{r message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Bramois <- as_tsibble(Bramois)
weekday <- weekdays(Bramois$date)
Bramois$weekday <- weekday # Get the weekday values
Bramois$time <- as.POSIXct(Bramois$date, format = "%H:%M:%S %p")
Bramois$time <- as.numeric(Bramois$date) #convert date values to numeric
as.numeric(Bramois$time)

bramois <- Bramois %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
bramois$minutes <- as.numeric(as.character(bramois$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
bramois <- bramois %>% filter(minutes == 10) %>%
  select(-time,-name) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
bramois.gaps <- has_gaps(bramois)
bramois.gaps <- scan_gaps(bramois)
bramois <- bramois %>% 
  fill_gaps(.full = TRUE) 


# Replace NA's values as previous row 
bramois_ts <- bramois %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes)
scan_gaps(bramois_ts) # no missing values

#  convert our data frame from wide to long format.
bramois <- bramois_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```

```{r, echo=FALSE, message=FALSE}
# Create table of Usage of the station
bramois %>% 
  select(-weekday, -minutes) %>%
  autoplot(Number) +
  xlab("Date [10 min]") + ylab("Number of bike") +
  ggtitle("Usage frequencies in UNIL/UNIGE Bramois station")

# Sum Bikes with E-Bikes to have total column of bikes
bramois_ts$Bramois <- bramois_ts$Bike + bramois_ts$`E-Bike`
bramois_ts <- bramois_ts %>% 
  select(date, Bramois)
```

### **Sion Time series**

```{r message=FALSE, warning=FALSE, include=FALSE}
library(purrr)
sion_ts <- list(bietschhorn_ts, blancherie_ts, cible_ts, gsd_ts, prp_ts, 
                platta_ts, planta_ts, crr_ts, campus_ts, scex_ts, furet_ts,
                agasse_ts, stade_ts, gsn_ts, stand_ts, bramois_ts) %>%
  reduce(dplyr::left_join, by= "date")

# Convert ts to tsibble and pivot to long format
sion_ts_long <- sion_ts %>%   
  gather("Bietschhorn", "Blancherie", "Cible", "GSD", "PRP", "Platta", "Planta",
         "CRR", "Campus", "Scex", "Furet", "Agasse", "Stade", "GSN", "Stand",
         "Bramois", key = Stations, value = Number)

#$date <- as.Date(sion_ts_long$date)
#sion_ts_long <- sion_ts_long %>%
#  as.data.frame() %>%
#  dplyr::group_by(date, Stations) %>%
#  dplyr::summarise(Number = median(Number)) %>%
#  as_tsibble(key = Stations)
#sion_ts_long$Number <- ceiling(sion_ts_long$Number)
```


```{r, echo=FALSE, message=FALSE}
sion_ts_long %>% autoplot(Number) + ylab("Number of Bikes") +
  facet_wrap(vars(Stations), scales = "free_y", ncol = 4) + 
  theme(legend.position = "none") + 
  ggtitle("Past counts of bicycles at Sion stations")
```



