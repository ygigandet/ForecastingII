```{r, echo = FALSE, message = FALSE, warning=FALSE}
source(here::here("scripts/setup.R"))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Setting the functions to local environment "English" 
Sys.setlocale("LC_TIME", "C")
```

#### **Sion bike sharing**

Our work is to forecast the number of bikes available for every 10 minutes of Wednesday, May 25th, at every stations in the city of Sion.

To do so, we first compile for each stations the number of bikes available only on Wednesdays. It will help us to gain some insights on particular trends for this day of the week.

Most of the stations show a pattern between the hours from 06:00 to 12:00, where the amount of bikes decrease and then increase from 12:00 to 18:00. There are special cases in which those patterns are at the inverse, those signs could be related by the location of this stations, and the purpose of their users. 

* **Stations that Increase - Decrease** 
    + Campus Energypolis 
    + HÃ´pital - CRR 
    + Gare de Sion Sud 
    + Gare de Sion Nord (E-Bike)
    
* **Stations that Decrease - Increase** 
    + Bietschhorn 
    + Platta (E-Bike)
    + P+R Potence
    + Ancien Stand (E-Bike)
    

#### **Bietschhorn Station**

```{r, message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Bietschhorn <- as_tsibble(Bietschhorn)
Bietschhorn$weekday <- weekdays(Bietschhorn$date) # Get the weekday values
Bietschhorn$time <- as.POSIXct(Bietschhorn$date, format = "%H:%M:%S %p")
Bietschhorn$time <- as.numeric(Bietschhorn$date) #convert date values to numeric
as.numeric(Bietschhorn$time)

bietschhorn <- Bietschhorn %>% 
  mutate(minutes = time - lag(time, default = first(time))) # subtract days
bietschhorn$minutes <- as.numeric(as.character(bietschhorn$minutes))/60 # transform to minutes

# Filter the data by time difference of 10 min
bietschhorn <- bietschhorn %>% filter(minutes == 10) %>%
  select(-time) %>%
  relocate(date, .before = Bike)

# Identifying the gaps on the ts and fill them
bietschhorn.gaps <- has_gaps(bietschhorn)
bietschhorn.gaps <- scan_gaps(bietschhorn)
bietschhorn <- bietschhorn %>% 
  fill_gaps(.full = TRUE) 

# Replace NA's values as previous row 
bietschhorn_ts <- bietschhorn %>%
  fill(Bike, `E-Bike`, Capacity, weekday, minutes, name)
scan_gaps(bietschhorn_ts) # no missing values

#  convert our data frame from wide to long format.
bietschhorn <- bietschhorn_ts %>% 
  gather("Bike", "E-Bike", "Capacity", key = Types, value = Number) %>%
  relocate(Types, .before = weekday) %>%
  relocate(Number, .before = weekday)
```

```{r, message=FALSE, warning=FALSE}
### Usage for Wednesdays - Bikes ###
bietschhorn_wednesday <- bietschhorn %>%
  filter(weekday == "Wednesday") 
lubridate::day(bietschhorn_wednesday$date) <- 16
lubridate::month(bietschhorn_wednesday$date) <- 04
bietschhorn_wednesday <- bietschhorn_wednesday %>%
  group_by(date, Types) %>%
  summarise(Number = median(Number)) %>%
  as_tsibble(key = Types) %>%
  mutate(weekday = "Wednesday")
bietschhorn_wednesday$Number <- ceiling(bietschhorn_wednesday$Number)

bietschhorn_wednesday %>% 
  select(-weekday) %>%
  autoplot(Number) +
  labs(x = "Time [10']",
       y = "Number") + 
  ggtitle("Wednesdays Usage(Mdn) - Bietschhorn")

### Time series for Wednesdays - Bike ###
bietschhorn_wednesdays_bike <- bietschhorn %>% 
  filter(Types == "Bike" ) %>% 
  filter(weekday == "Wednesday") %>%
  mutate(t = row_number()) %>% 
  update_tsibble(index = t, regular = TRUE)

p1 <- bietschhorn_wednesdays_bike %>% 
  autoplot(Number) +
  geom_vline(xintercept=c(54,198,342,486,630,774,918,1062,1206), linetype="dotted") + #Per day
  ggtitle("Wednesdays time series - Bike - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number")

# Time series for Wednesdays - E-Bike
bietschhorn_wednesdays_ebike <- bietschhorn %>% 
  filter(Types == "E-Bike") %>% 
  filter(weekday == "Wednesday") %>%
  mutate(t = row_number()) %>% 
  update_tsibble(index = t, regular = TRUE)

p2 <- bietschhorn_wednesdays_ebike %>% 
  autoplot(Number) +
  geom_vline(xintercept=c(54,198,342,486,630,774,918,1062,1206), linetype="dotted") + # per day
  ggtitle("Wednesdays time series - E-Bike - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number")
p1 / p2 
```

```{r message=FALSE, warning=FALSE}
# Is it white noise for the bike at the bietschhorn? 
p1 <- bietschhorn_wednesdays_bike %>% 
  ACF(Number, lag_max = 144) %>% 
  autoplot() +  ggtitle("Bike")

# Is our time series stationary or not? #We confirm it with the test
bietschhorn_wednesdays_bike %>% features(Number, unitroot_kpss) 

#The p-value of 0.01 indicates strong evidence to 
#reject the null hypothesis of stationarity.

# Is our time series stationary or not? #We confirm it with the test
bietschhorn_wednesdays_ebike %>% features(Number, unitroot_kpss) # No p-value < 0.05

# Is it white noise for the bike at the bietschhorn?
p2 <- bietschhorn_wednesdays_ebike %>% 
  ACF(Number, lag_max = 144) %>% 
  autoplot() +  ggtitle("E-Bike")
p1 / p2
```

#### **Forecast**

> **Bike**

```{r, message=FALSE, warning=FALSE}
############################################################################################
                                      ###   Forecast  ###
############################################################################################

# Forecast for Bike in Bietschhorn
fit <- bietschhorn_wednesdays_bike[1:1062,] %>%
  model(ETS = ETS(Number),
        ARIMA = ARIMA(Number),
        TSLM = TSLM(Number ~ trend())) %>%
  mutate(Combination = (ETS + ARIMA + TSLM) / 3)
fc <- fit %>% forecast(h = 144)
fc %>% autoplot(bietschhorn_wednesdays_bike, level = NULL) +
  guides(colour=guide_legend(title = "Models")) +
  ggtitle("Wednesday Forecast - Bike - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number") 

# Compare models and arrange by RMSE to select the best
fc %>% accuracy(bietschhorn_wednesdays_bike) %>% arrange(RMSE)


###################################   Linear Regression   ###############################

# Prepare data for Forecast
tslm <- bietschhorn_ts %>%
  dplyr::left_join(weather_data, by = "date") %>%
  na.omit() %>%
  filter(weekday == "Wednesday") %>%
  mutate(t = row_number()) %>% 
  update_tsibble(index = t, regular = TRUE)

######## Build the model for Bike #######

tslm_model_bike <- tslm[1:1008,] %>% 
  model(TSLM = TSLM(Bike ~ Air_Temperature + Precipitation +
                      Virtual_Temperature + Wind_Speed))

# Look at the Coefficients and Residuals
report(tslm_model_bike)
tslm_model_bike %>% gg_tsresiduals()
```

> **E-Bike**

```{r, message=FALSE, warning=FALSE}
# Forecast for E-Bike in Bietschhorn
fit <- bietschhorn_wednesdays_ebike[1:1062,] %>%
  model(ETS = ETS(Number),
        ARIMA = ARIMA(Number),
        TSLM = TSLM(Number ~ trend())) %>%
  mutate(Combinatiion = (ETS + ARIMA) / 2)
fc <- fit %>% forecast(h = 144)
fc %>% autoplot(bietschhorn_wednesdays_ebike, level = NULL) +
  guides(colour=guide_legend(title = "Models")) +
  ggtitle("Wednesday Forecast - E-Bike - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number") 


# Compare models and arrange by RMSE to select the best
fc %>% accuracy(bietschhorn_wednesdays_ebike) %>% arrange(RMSE)

###################################   Linear Regression   ###############################

######## Build the model for eBike #######

tslm_model_ebike <- tslm[1:1008,] %>% 
  model(TSLM = TSLM(`E-Bike` ~ Air_Temperature + Precipitation +
                      Virtual_Temperature + Wind_Speed))

# Look at the Coefficients and Residuals
report(tslm_model_ebike)
tslm_model_ebike %>% gg_tsresiduals()
```

```{r}
#### Forecast for the 2022-05-04

# Keep only weather information for this time
weather_scenario <- weather_data %>% 
  filter(as_date(date) == as_date('2022-05-04'))

# Create a scenario based on the inputs of weather
scenario <- new_data(tslm, n = 144) %>% 
  mutate(Air_Temperature=weather_scenario$Air_Temperature,
         Precipitation=weather_scenario$Precipitation,
         Virtual_Temperature=weather_scenario$Virtual_Temperature,
         Wind_Speed=weather_scenario$Wind_Speed)

# TSLM model
tslm_model_bike <- tslm %>% 
  model(TSLM = TSLM(Bike ~ Air_Temperature + Precipitation +
                      Virtual_Temperature + Wind_Speed))
tslm_model_bike %>% 
  report()

# See graphically how well TSLM performs
augment(tslm_model_bike) %>% 
  ggplot(aes(x = t)) +
  geom_line(aes(y = tslm$Bike, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted"))

# Another graph
augment(tslm_model_bike) %>% 
  ggplot(aes(x = tslm$Bike, y = .fitted)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)

# Forecast
fc <- forecast(tslm_model_bike, new_data = scenario) %>% 
  as_fable(response = "Bike")

tslm %>% 
  autoplot(Bike) +
  autolayer(fc, level = 0)
```
