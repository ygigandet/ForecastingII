
## Exploration and Visualization

Our work is to forecast the number of bikes available for every 10 minutes of Wednesday, May 25th, at every stations in the city of Sion. To do so, we first wanted to visualize the location of all the stations in Sion, so we could understand better the distance between the stations and the possible purpose for which each user would use the bikes. In addition, we will be able to identify the surroundings at each station, and determine if it's a residential/educational or a business area.

On the following map, we can observe how the stations (blue markers) are distributed around Sion city. The stations Châteauneuf-Furet (left) and UNIL/UNIGE Bramois (right) are the farthest from the center of Sion, while Gare de Sion Nord, Gare de Sion Sud, and Campus Energypolis are at the center. Now, we segment by area type each station:

*  **Residential / Education Area:** 
Blancherie, Ancien Stand, P+R Potence, Châteauneuf-Furet, Scex, Platta, Agasse,
Bietschhorn, P+R Stade, UNIL/UNIGE Bramois               

* **Business Area:**
Gare de Sion Nord (GSN),  Gare de Sion Sud (GSD), Campus Energypolis, Cible, Planta, Hôpital - CRR

```{r, echo=FALSE, message=FALSE}
stations <- leaflet(height=300, width=900) %>% 
  addTiles() %>% 
  setView(lng = 7.368145, lat = 46.232163, zoom = 14) %>%
  addMarkers(lng=7.359509, lat=46.227851, label="Gare de Sion Nord")%>%
  addMarkers(lng=7.359278, lat=46.226600, label="Gare de Sion Sud")%>%
  addMarkers(lng=7.362768, lat=46.226805, label="Campus Energypolis")%>%
  addMarkers(lng=7.354689, lat=46.225429, label="Blancherie")%>%
  addMarkers(lng=7.350697, lat=46.228497, label="Ancien Stand")%>%
  addMarkers(lng=7.342870, lat=46.226620, label="P+R Potence")%>%
  addMarkers(lng=7.333030, lat=46.224212, label="Châteauneuf-Furet")%>%
  addMarkers(lng=7.363206, lat=46.232220, label="Scex")%>%
  addMarkers(lng=7.358595, lat=46.232493, label="Planta")%>%
  addMarkers(lng=7.361292, lat=46.235840, label="Cible")%>%
  addMarkers(lng=7.364446, lat=46.238478, label="Platta")%>%
  addMarkers(lng=7.350275, lat=46.235155, label="Agasse")%>%
  addMarkers(lng=7.373780, lat=46.230535, label="Bietschhorn")%>%
  addMarkers(lng=7.377835, lat=46.235056, label="P+R Stade")%>%
  addMarkers(lng=7.386038, lat=46.234684, label="Hôpital - CRR")%>%
  addMarkers(lng=7.400422, lat=46.231082, label="UNIL/UNIGE Bramois")
stations 

```

```{r, message=FALSE, warning=FALSE, include=FALSE}
# Creation of time series
Bietschhorn <- as_tsibble(Bietschhorn, index = date)
Blancherie <- as_tsibble(Blancherie, index = date)
Cible <- as_tsibble(Cible, index = date)
GSD <- as_tsibble(GSD, index = date)
PRP <- as_tsibble(PRP, index = date)
Platta <- as_tsibble(Platta, index = date)
Planta <- as_tsibble(Planta, index = date)
CRR <- as_tsibble(CRR, index = date)
Campus <- as_tsibble(Campus, index = date)
Scex <- as_tsibble(Scex, index = date)
Furet <- as_tsibble(Furet, index = date)
Agasse <- as_tsibble(Agasse, index = date)
Stade <- as_tsibble(Stade, index = date)
GSN <- as_tsibble(GSN, index = date)
Stand <- as_tsibble(Stand, index = date)
Bramois <- as_tsibble(Bramois, index = date)
  
  
############ Prepare data ################

bietschhorn_bike <- Bietschhorn %>%
  rename(Bietschhorn = Bike) %>%
  select(date, Bietschhorn)
bietschhorn_ebike <- Bietschhorn %>%
  rename(Bietschhorn = `E-Bike`) %>%
  select(date, Bietschhorn)

blancherie_bike <- Blancherie %>%
  rename(Blancherie = Bike) %>%
  select(date, Blancherie)
blancherie_ebike <- Blancherie %>%
  rename(Blancherie = `E-Bike`) %>%
  select(date, Blancherie)

cible_bike <- Cible %>%
  rename(Cible = Bike) %>%
  select(date, Cible)
cible_ebike <- Cible %>%
  rename(Cible = `E-Bike`) %>%
  select(date, Cible)

gsd_bike <- GSD %>%
  rename(GSD = Bike) %>%
  select(date, GSD)
gsd_ebike <- GSD %>%
  rename(GSD = `E-Bike`) %>%
  select(date, GSD)


prp_bike <- PRP %>%
  rename(PRP = Bike) %>%
  select(date, PRP)
prp_ebike <- PRP %>%
  rename(PRP = `E-Bike`) %>%
  select(date, PRP)


platta_bike <- Platta %>%
  rename(Platta = Bike) %>%
  select(date, Platta)
platta_ebike <- Platta %>%
  rename(Platta = `E-Bike`) %>%
  select(date, Platta)


planta_bike <- Planta %>%
  rename(Planta = Bike) %>%
  select(date, Planta)
planta_ebike <- Planta %>%
  rename(Planta = `E-Bike`) %>%
  select(date, Planta)


crr_bike <- CRR %>%
  rename(CRR = Bike) %>%
  select(date, CRR)
crr_ebike <- CRR %>%
  rename(CRR = `E-Bike`) %>%
  select(date, CRR)


campus_bike <- Campus %>%
  rename(Campus = Bike) %>%
  select(date, Campus)
campus_ebike <- Campus %>%
  rename(Campus = `E-Bike`) %>%
  select(date, Campus)


scex_bike <- Scex %>%
  rename(Scex = Bike) %>%
  select(date, Scex)
scex_ebike <- Scex %>%
  rename(Scex = `E-Bike`) %>%
  select(date, Scex)


furet_bike <- Furet %>%
  rename(Furet = Bike) %>%
  select(date, Furet)
furet_ebike <- Furet %>%
  rename(Furet = `E-Bike`) %>%
  select(date, Furet)


agasse_bike <- Agasse %>%
  rename(Agasse = Bike) %>%
  select(date, Agasse)
agasse_ebike <- Agasse %>%
  rename(Agasse = `E-Bike`) %>%
  select(date, Agasse)


stade_bike <- Stade %>%
  rename(Stade = Bike) %>%
  select(date, Stade)
stade_ebike <- Stade %>%
  rename(Stade = `E-Bike`) %>%
  select(date, Stade)


gsn_bike <- GSN %>%
  rename(GSN = Bike) %>%
  select(date, GSN)
gsn_ebike <- GSN %>%
  rename(GSN = `E-Bike`) %>%
  select(date, GSN)


stand_bike <- Stand %>%
  rename(Stand = Bike) %>%
  select(date, Stand)
stand_ebike <- Stand %>%
  rename(Stand = `E-Bike`) %>%
  select(date, Stand)


bramois_bike <- Bramois %>%
  rename(Bramois = Bike) %>%
  select(date, Bramois)
bramois_ebike <- Bramois %>%
  rename(Bramois = `E-Bike`) %>%
  select(date, Bramois)

################# Create Master tables #####################

library(purrr)
sion_bike <- list(bietschhorn_bike, blancherie_bike, cible_bike, gsd_bike, prp_bike, 
                platta_bike, planta_bike, crr_bike, campus_bike, scex_bike, furet_bike,
                agasse_bike, stade_bike, gsn_bike, stand_bike, bramois_bike) %>%
  reduce(dplyr::left_join, by= "date")

sion_ebike <- list(bietschhorn_ebike, blancherie_ebike, cible_ebike, gsd_ebike, 
                  prp_ebike, platta_ebike, planta_ebike, crr_ebike, campus_ebike,
                  scex_ebike, furet_ebike, agasse_ebike, stade_ebike, gsn_ebike,
                  stand_ebike, bramois_ebike) %>%
  reduce(dplyr::left_join, by= "date")

# Convert ts to tsibble and pivot to long format
sion_bike_long <- sion_bike %>%   
  gather("Bietschhorn", "Blancherie", "Cible", "GSD", "PRP", "Platta", "Planta",
         "CRR", "Campus", "Scex", "Furet", "Agasse", "Stade", "GSN", "Stand",
         "Bramois", key = Stations, value = Number)

sion_ebike_long <- sion_ebike %>%   
  gather("Bietschhorn", "Blancherie", "Cible", "GSD", "PRP", "Platta", "Planta",
         "CRR", "Campus", "Scex", "Furet", "Agasse", "Stade", "GSN", "Stand",
         "Bramois", key = Stations, value = Number)


sion_bike_diff<- sion_bike
sion_bike_diff$time <- as.POSIXct(sion_bike_diff$date, format = "%H:%M:%S %p")
sion_bike_diff$time <- as.numeric(sion_bike_diff$date) #convert date values to numeric
as.numeric(sion_bike_diff$time)
sion_bike_diff <- sion_bike_diff %>% 
  mutate(Minutes = time - lag(time, default = first(time))) # subtract days
sion_bike_diff$Minutes <- as.numeric(as.character(sion_bike_diff$Minutes))/60 # transform to minutes
sion_bike_diff$Minutes[1] <- 60

sion_bike_diff <- sion_bike_diff %>%
  as.data.frame() %>%
  select(Minutes)

sion_bike_table <- sion_bike %>%
  as.data.frame() %>%
  select(-date)
```

In order to observe the availability of Bikes at each station from the past weeks, we plot on the following chart the probability that a certain amount of bikes will be available.

```{r, echo=FALSE, message=FALSE, heigth= }
x<-inspect_num(sion_bike_table)
show_plot(x, col_palette=3, plot_layout = c(4, 4)) +
  ggtitle("Bike Probability per Station")
```

<br> From these graphs, we could observe the patterns as follow:

+ Bietschhorn, Campus and GSN stations seem to have a similar probability across the number of bicycles with the highest probability is at number 7, and GSD station with the highest at 3. We can also mention that the flow of users at these stations is more constant than at the rest.

+ The stations Agasse and Platta show the highest probability than the rest of the stations with an amount of 0 bikes across their number of bikes. Moreover, we note a similar pattern on Cible and Planta, but with a lower probability.

+ The rest of the stations have a different pattern than the rest, some with the highest peak at number 4 (Blancherie, Furet, PRP), some at number 2 (Bramois), and rare cases such as Stade that have several peaks (4,5,6). 

One important discovery that we found during the exploratory analysis was that most of the observations were measured every 10 minutes, but there were also some observations with values measured by 20, 30, 40, 70, 60, and 120 minutes that we had to remove as they represent less than 2% of our data.

```{r, echo=FALSE, message=FALSE}
# Table containing the time differences different from 10 min interval
library(gtsummary)
tbl_summary(
  sion_bike_diff,
  type = all_continuous() ~ "continuous2",
  statistic = list(all_continuous() ~ c("{median}, ({p25}, {p75})",
                                        "{mean}, ({min}, {max})"),
                   all_categorical() ~ "{n}, ({p}%)")) %>%
  modify_caption("**Time Interval in Timeseries**") %>%
  bold_labels()

#kbl(sion_bike_diff) %>%
# kable_styling(bootstrap_options = "striped", full_width = F, position = "float_right")
```

```{r, echo=FALSE, message=FALSE}

########### Plot Them ################

sion_bike_long %>% autoplot(Number) + ylab("Number of Bikes") +
  facet_wrap(vars(Stations), ncol = 4) + 
  theme(legend.position = "none") + guides(x =  guide_axis(angle = 25)) +
  labs(x = "Time [10']",
       y = "Number") +
  ggtitle("Sion Stations - Bike Usage")

sion_ebike_long %>% autoplot(Number) + ylab("Number of Bikes") +
  facet_wrap(vars(Stations), ncol = 4) + 
  theme(legend.position = "none") + guides(x =  guide_axis(angle = 25)) +
  labs(x = "Time [10']",
       y = "Number") +
  ggtitle("Sion Stations - E-Bike Usage")
```

## 2. Cleaning and Wrangling

Your data will probably require some preliminary transformations before being able to work on it. This includes, but is not limited to, dealing with missing values (sometimes the values are measured every 10 minutes, sometimes every 30 minutes), detecting and treating outliers, creating new variables, etc.

## 3. Modeling

This part is about building on your knowledge of time series techniques to model your data. You can investigate various models but you should justify in your report your choices regarding these. Pay attention to the conditions that are needed to apply a specific model.Treat also carefully seasonality, outliers, colinearity, covariates, special events, etc.

Remember the following steps: (a) Aggregation choice for hierarchical time series (b) Model building (c) Model selection
