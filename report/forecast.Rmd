## **Forecasts**

```{r}
# Parameters for all forecasts

# The time interval of our time series - the latest one would be 1350
interval = 1206 # interval for all wednesdays
interval_fc = 1062 # interval from the last one
day_forecasted = '2022-05-04'
```

#### **Bietschhorn Station**

```{r}
# Parameters for this station
station = bietschhorn_wednesdays_bikes
station <- station[-c(1:54),] %>% 
  mutate(t = row_number())
```

```{r, message=FALSE, warning=FALSE}
### Time series for Wednesdays - Bikes ###

# Plot the time series for every wednesdays
station %>% 
  autoplot(Number) +
  geom_vline(xintercept=seq(54, interval, 144), linetype="dotted") + #Per day
  ggtitle("Wednesdays time series - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number of bikes available")
```

```{r}
# Is it white noise for the bike at the bietschhorn? 
station %>% 
  ACF(Number, lag_max = 144) %>% 
  autoplot() +  ggtitle("Bike")

# Is our time series stationary or not? #We confirm it with the test
station %>% features(Number, unitroot_kpss) 

#The p-value of 0.01 indicates strong evidence to 
#reject the null hypothesis of stationarity.
```

```{r, message=FALSE, warning=FALSE}
############################################################################################
                                      ###  Forecasts  ###
############################################################################################

# Forecast for bikes in Bietschhorn
fit <- station[54:1008,] %>%
  model(ETS = ETS(Number),
        ARIMA = ARIMA(Number),
        NAIVE = NAIVE(Number)) %>%
  mutate(Combination = (ETS + ARIMA + NAIVE) / 3)

fc <- fit %>% forecast(h = 144)

fc %>% autoplot(station[54:interval,], level = NULL) +
  guides(colour=guide_legend(title = "Models")) +
  ggtitle("Forecast bikes - Bietschhorn") +
  labs(x = "Time [10']",
       y = "Number") 

# Compare models and arrange by RMSE to select the best
fc %>% accuracy(station) %>% arrange(RMSE)


###################################   Linear Regression   ###############################

# Prepare data for Forecast
tslm <- station %>%
  dplyr::left_join(weather_data, by = "date") %>%
  na.omit() %>%
  filter(weekday == "Wednesday") %>%
  mutate(t = row_number()) %>% 
  update_tsibble(index = t, regular = TRUE)

# Keep only weather information for this time
weather_scenario <- weather_data %>% 
  filter(as_date(date) == as_date(day_forecasted))

######## Build the model for Bike #######

bietschhorn_wednesdays_bikes_fc <- station %>% 
  filter(as_date(date) < as_date(day_forecasted))

# TSLM_forecast
tslm_forecast <- tslm %>% 
  filter(as_date(date) < as_date(day_forecasted))

# Create a scenario based on the inputs of weather
scenario <- new_data(tslm_forecast, n = 144) %>% 
  mutate(Air_Temperature=weather_scenario$Air_Temperature,
         Precipitation=weather_scenario$Precipitation,
         Virtual_Temperature=weather_scenario$Virtual_Temperature,
         Wind_Speed=weather_scenario$Wind_Speed)

# TSLM model
tslm_model_bikes <- tslm_forecast %>% 
  model(TSLM = TSLM(Number ~ Air_Temperature + Precipitation +
                      Virtual_Temperature + Wind_Speed))

fc <- forecast(tslm_model_bikes, new_data = scenario) %>% 
  as_fable(response = "Number")

tslm_forecast %>% 
  autoplot(Number) +
  autolayer(fc, level = 0)

tslm %>% 
  filter(as_date(date) <= as_date(day_forecasted)) %>% 
  autoplot(Number)

# Look at the Coefficients and Residuals
report(tslm_model_bikes)
tslm_model_bike %>% gg_tsresiduals()

fc %>% accuracy(station) %>% arrange(RMSE)
```

#### **Blancherie Station**

```{r}
# Parameters for this station
station = blancherie_wednesdays_bikes
station <- station[-c(1:54),] %>% 
  mutate(t = row_number())
```

```{r, message=FALSE, warning=FALSE}
### Time series for Wednesdays - Bikes ###

# Plot the time series for every wednesdays
station %>% 
  autoplot(Number) +
  geom_vline(xintercept=seq(54, interval, 144), linetype="dotted") + #Per day
  ggtitle("Wednesdays time series - Blancherie") +
  labs(x = "Time [10']",
       y = "Number of bikes available")
```

```{r}
# Is it white noise for the bike at the blancherie? 
station %>% 
  ACF(Number, lag_max = 144) %>% 
  autoplot() +  ggtitle("Bike")

# Is our time series stationary or not? #We confirm it with the test
station %>% features(Number, unitroot_kpss) 

#The p-value of 0.01 indicates strong evidence to 
#reject the null hypothesis of stationarity.
```

```{r, message=FALSE, warning=FALSE}
############################################################################################
                                      ###  Forecasts  ###
############################################################################################

# Forecast for bikes in blancherie
fit <- station[1:1008,] %>%
  model(ETS = ETS(Number),
        ARIMA = ARIMA(Number),
        NAIVE = NAIVE(Number)) %>%
  mutate(Combination = (ETS + ARIMA + NAIVE) / 3)

fc <- fit %>% forecast(h = 144)

fc %>% autoplot(station[54:interval,], level = NULL) +
  guides(colour=guide_legend(title = "Models")) +
  ggtitle("Forecast bikes - Blancherie") +
  labs(x = "Time [10']",
       y = "Number") 

# Compare models and arrange by RMSE to select the best
fc %>% accuracy(station) %>% arrange(RMSE)


###################################   Linear Regression   ###############################

# Prepare data for Forecast
tslm <- station %>%
  dplyr::left_join(weather_data, by = "date") %>%
  na.omit() %>%
  filter(weekday == "Wednesday") %>%
  mutate(t = row_number()) %>% 
  update_tsibble(index = t, regular = TRUE)

# Keep only weather information for this time
weather_scenario <- weather_data %>% 
  filter(as_date(date) == as_date(day_forecasted))

######## Build the model for Bike #######

bietschhorn_wednesdays_bikes_fc <- station %>% 
  filter(as_date(date) < as_date(day_forecasted))

# TSLM_forecast
tslm_forecast <- tslm %>% 
  filter(as_date(date) < as_date(day_forecasted))

# Create a scenario based on the inputs of weather
scenario <- new_data(tslm_forecast, n = 144) %>% 
  mutate(Air_Temperature=weather_scenario$Air_Temperature,
         Precipitation=weather_scenario$Precipitation,
         Virtual_Temperature=weather_scenario$Virtual_Temperature,
         Wind_Speed=weather_scenario$Wind_Speed)

# TSLM model
tslm_model_bikes <- tslm_forecast %>% 
  model(TSLM = TSLM(Number ~ Air_Temperature + Precipitation +
                      Virtual_Temperature + Wind_Speed))

fc <- forecast(tslm_model_bikes, new_data = scenario) %>% 
  as_fable(response = "Number")

tslm_forecast %>% 
  autoplot(Number) +
  autolayer(fc, level = 0)

tslm %>% 
  filter(as_date(date) <= as_date(day_forecasted)) %>% 
  autoplot(Number)

# Look at the Coefficients and Residuals
report(tslm_model_bikes)
tslm_model_bike %>% gg_tsresiduals()

fc %>% accuracy(station) %>% arrange(RMSE)
```
